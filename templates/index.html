<html>
<head>
    <title>Pathogen Informatics Data</title>
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.10/css/dataTables.bootstrap.min.css">
    <script src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.10/js/dataTables.bootstrap.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <style>
    .scrollable-dropdown {
        height: auto;
        max-height: 200px;
        overflow-x: hidden;
    }
    </style>
</head>
<body>
    <div class="container">
        <div class="row page-header">
            <div class="col-md-4">
                <img alt="Wellcome Trust Sanger Institute Logo" width=300 src="assets/img/logo.png">
            </div>
            <div class="col-md-8">
                <h2 class="media-heading">Wellcome Trust Sanger Institute<br>Pathogen Data</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" type="button" id="species_selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                      Pick your pathogen
                      <span class="caret"></span>
                    </button>
                    <ul id="species_list" class="dropdown-menu scrollable-dropdown" aria-labelledby="species_selector">
                    {% for name, url in (species_urls.items() | sort) %}
                        <li><a href='{{ url }}'>{{ name }}</a></li>
                    {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" type="button" id="project_selector" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                      All Projects
                      <span class="caret"></span>
                    </button>
                    <ul id="project_list" class="dropdown-menu scrollable-dropdown" aria-labelledby="project_selector">
                    </ul>
                </div>
            </div>
        </div>
        <div id="wait-div" class="row" style="display: none;">
          <div class="col-md-12">
              <h4><i class="fa fa-spinner fa-pulse"></i> Please wait while we load your data</h4>
          </div>
        </div>
        <div class="row">
          <div id="data-div" class="col-md-12">
              <table id="data-table" class="display">
                  <thead>
                        <tr>
                            <th>Project Name</th>
                            <th>Sample Name</th>
                            <th>Lane ID</th>
                            <th>Lane Accession</th>
                            <th>Project ID</th>
                            <th>Accession</th>
                            <th>Study ID</th>
                            <th>Species Name</th>
                        </tr>
                    </thead>
              </table>
          </div>
        </div>
    </div>
    <script>
      var table;
      function update_table_from_link(table, link) {
          $('#data-div').hide();
          $('#wait-div').show();
          url = $(link).attr('href');
          species = $(link).text();
          $('#species_selector').text(species);
          table.ajax.url(url).load(function () {
            $('#data-div').show();
            $('#wait-div').hide();
            update_project_lists_from_table(table);
          });
      }
      function update_project_lists_from_table(table) {
        table.column(0).search('').draw();
        $('#project_selector').text("All Projects");
        var projects = table.column(0).data().unique().sort();
        var project_list = $('#project_list');
        project_list.empty();
        project_list.append('<li><a href="#">All Projects</a></li>');
        projects.each ( function (d, j) {
          project_list.append('<li><a href="#'+j+'">' + d + '</a></li>');
        });
        $("#project_list a").click(function (event) {
          event.preventDefault();
          var project_name = $(this).text();
          $('#project_selector').text(project_name);
          if (project_name == 'All Projects') {
            table.column(0).search('').draw();
          } else {
            table.column(0).search('^' + $.fn.dataTable.util.escapeRegex(project_name) + '$', true, false).draw();
          }
        });
      }
      $(document).ready( function() {
        var first_link=$('#species_list a').first();
        var url = first_link.attr('href');
        var species = first_link.text();
        table = $("#data-table").DataTable();
        $('#species_list a').click(function (event){
          event.preventDefault();
          update_table_from_link(table, this);
        })
      })
    </script>
<body>
